<!DOCTYPE html>
<html lang="en">
<link href='http://alexgorbatchev.com/pub/sh/current/styles/shCore.css' rel='stylesheet' type='text/css'/>
<link href='http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css' rel='stylesheet' type='text/css'/>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shCore.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushCpp.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushCSharp.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushCss.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJava.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushJScript.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPhp.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPython.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushRuby.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushSql.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushVb.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushXml.js' type='text/javascript'></script>
<script src='http://alexgorbatchev.com/pub/sh/current/scripts/shBrushPerl.js' type='text/javascript'></script>
<script language='javascript'>
  SyntaxHighlighter.config.bloggerMode = true;
  SyntaxHighlighter.config.clipboardSwf = 'http://alexgorbatchev.com/pub/sh/current/scripts/clipboard.swf';
  SyntaxHighlighter.all();
</script>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="coffeetechgaff.com">
    <meta name="author" content="coffeetechgaff.com">

    <title>coffeetechgaff - Blogs</title>

    <!-- Bootstrap Core CSS -->
    <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <!-- Theme CSS -->
    <link href="../../css/clean-blog.min.css" rel="stylesheet" type="text/css">

    <!-- Custom Fonts -->
    <link href="../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="../../index.html">coffeetechgaff.com</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="../../index.html">Home</a>
                    </li>
                    <li>
                        <a href="../../about.html">About</a>
                    </li>
                    <li>
                        <a href="../../posts.html">Blog</a>
                    </li>
                    <li>
                        <a href="../../contact.html">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="intro-header" style="background-image: url('../../img/elasticsearch-logo.png')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Testing Mapping with Embedded Elasticsearch Server</h1>
                        <span class="meta">Posted by <a href="../../about.html">coffeetechgaff</a> on April 10, 2017</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <p>Running instance of Elasticsearch cluster server won’t available for unit test. On the other hand, unit test shouldn’t depend on the external running instance. If you want to test the real Elasticsearch behavior in unit test, you can use embedded Elasticsearch server instance. Embedded Elasticsearch server is a small instance of Elasticsearch cluster and it works exactly as Elasticsearch cluster as a whole. You need following dependency in POM file to run Elasticsearch as embedded in your application for unit test.</p>

                    <pre class="brush: xml">
                      <!-- https://mvnrepository.com/artifact/org.mockito/mockito-all -->
                      <dependency>
                          <groupId>org.elasticsearch</groupId>
                          <artifactId>elasticsearch</artifactId>
                          <version>5.2.1</version>
                      </dependency>
                          <dependency>
                          <groupId>org.elasticsearch.client</groupId>
                          <artifactId>transport</artifactId>
                          <version>5.2.1</version>
                      </dependency>
                      <dependency>
                          <groupId>com.google.guava</groupId>
                          <artifactId>guava</artifactId>
                          <version>21.0</version>
                      </dependency>
                    </pre>
                    <p>Following code tests that whether the mapping has been created in Elasticsearch or not. We can do using Mockito. However, I don’t think Mockito will give us full confidence on our code. I am using embedded Elasticsearch to make sure I can create index and mapping without any issue. If you want to see the mapping, Please click here for my mapping tutorial.</p>
                    <pre class="brush: java">
                      package com.vsubedi.elasticsearch;

                      import static org.junit.Assert.*;

                      import java.io.File;
                      import java.io.IOException;

                      import org.elasticsearch.action.admin.indices.delete.DeleteIndexResponse;
                      import org.elasticsearch.action.admin.indices.exists.indices.IndicesExistsResponse;
                      import org.elasticsearch.client.Client;
                      import org.elasticsearch.common.settings.Settings;
                      import org.elasticsearch.node.Node;
                      import org.junit.AfterClass;
                      import org.junit.BeforeClass;
                      import org.junit.Test;
                      import org.slf4j.Logger;
                      import org.slf4j.LoggerFactory;

                      import com.google.common.io.Files;

                      /**
                       *
                       * @author vsubedi
                       *
                       */
                      public class PrepareIndexTest {

                          private static final Logger logger = LoggerFactory.getLogger(PrepareIndexTest.class);

                          private static Node server;
                          private static Client client;
                          private static File tempDir;
                          private static String index = "test";
                          private static String docType = "movies";

                          @BeforeClass
                          public static void setUpBeforeClass() throws Exception {
                              logger.info("======= START INTEGRATION TEST ========");

                              // spinning up the elasticsearch server for junit
                              tempDir = Files.createTempDir();
                              logger.info(tempDir.getAbsolutePath());
                              Settings settings = Settings.builder().put("path.home", tempDir.getAbsolutePath())
                                      .put("transport.type", "local")
                                      .put("http.enabled", false)
                                      .build();
                              server = new Node(settings);
                              final String clusterName = server.settings().get("cluster.name");

                              logger.info("starting server with cluster-name: [{}]", clusterName);
                              server.start();

                              client = server.client();
                          }

                          @AfterClass
                          public static void tearDownAfterClass() throws Exception {
                              DeleteIndexResponse deleteIndexResponse = client.admin().indices()
                                      .prepareDelete(index).get();
                              assertTrue(String.valueOf(deleteIndexResponse.isAcknowledged()).equalsIgnoreCase("true"));
                              tempDir.delete();
                              client.close();
                              server.close();
                              logger.info("======= END INTEGRATION TEST ========");
                          }

                          @Test
                          public void testPrepareIndex() throws IOException {
                              //creating index
                              IndexAndCreateMapping.prepareIndex(client, index, docType);

                              //checking if the index has been created or not
                              IndicesExistsResponse indexResponse = client.admin().indices().prepareExists(index).get();

                              //it should be true
                              assertTrue(indexResponse.isExists());
                          }

                      }
                    </pre>
                    <p>Above code is for Elasticsearch version 5.2.1. If you want to run for previous versions like 2.4.0, you need to use NodeBulder to create a embedded Elasticsearch instance as follows:</p>
                    <pre class="brush: java">
                      tempDir = Files.createTempDir();
                      logger.info(tempDir.getAbsolutePath());
                      Settings settings = Settings.builder().put("path.home",
                      tempDir.getAbsolutePath()).build();
                      server = NodeBuilder.nodeBuilder().settings(settings).build();
                      final String clusterName = server.settings().get("cluster.name");

                      logger.info("starting server with cluster-name: [{}]", clusterName);
                      server.start();

                      client = server.client();
                    </pre>
                    <p>with following dependency.</p>
                    <pre class="brush: xml">
                      <dependency>
                          <groupId>org.elasticsearch</groupId>
                          <artifactId>elasticsearch</artifactId>
                          <version>2.4.1</version>
                          <scope>test</scope>
                          <type>test-jar</type>
                      </dependency>
                    </pre>
                </div>
                <hr>
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <div id="disqus_thread"></div>
                  <script>

                  /**
                  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                  var disqus_config = function () {
                  this.page.url = 'http://coffeetechgaff.com/2017/05/testing-mapping-with-embedded-elasticsearch-server.html';
                  this.page.identifier = '/2017/05/testing-mapping-with-embedded-elasticsearch-server.html';
                  };
                  (function() { // DON'T EDIT BELOW THIS LINE
                  var d = document, s = d.createElement('script');
                  s.src = 'https://coffeetechgaff-com.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
                  })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>
    </article>
    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://www.facebook.com/shree665">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/shree665">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Copyright &copy; coffeetechgaff.com <script>document.write(new Date().getFullYear())</script></p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="../../vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="../../js/jqBootstrapValidation.js"></script>
    <script src="../../js/contact_me.js"></script>

    <!-- Theme JavaScript -->
    <script src="../../js/clean-blog.min.js"></script>

    <!-- Discus comment count -->
    <script id="dsq-count-scr" src="//coffeetechgaff-com.disqus.com/count.js" async></script>
</body>

</html>
